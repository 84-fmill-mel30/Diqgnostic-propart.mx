<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>PROPART V108 - DIAGNOSTICO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { background: #050505; color: #0f0; font-family: 'Courier New', monospace; text-align: center; margin: 0; padding-bottom: 70px; overflow-x: hidden; }
        
        /* BLOQUEO */
        #lockScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        #lockScreen h1 { color: #f00; font-size: 40px; margin-bottom: 10px; }
        .btn-whatsapp { background: #25D366; color: #fff; padding: 15px 30px; border: none; border-radius: 50px; font-size: 18px; font-weight: bold; margin-top: 20px; text-decoration: none; }

        /* LEGAL */
        #legalModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .legal-box { border: 2px solid #f00; padding: 20px; border-radius: 10px; background: #100; box-shadow: 0 0 30px #f00; max-height: 80vh; overflow-y: auto; text-align: justify; }
        #btnAccept { background: #f00; color: #fff; border: none; padding: 15px; width: 100%; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 15px; border-radius: 5px; }

        /* GENERALES */
        nav { position: fixed; bottom: 0; width: 100%; background: #111; border-top: 1px solid #0f0; display: flex; justify-content: space-around; padding: 15px 0; z-index: 100; }
        nav button { background: none; border: none; color: #555; font-size: 24px; cursor: pointer; }
        nav button.active { color: #0f0; text-shadow: 0 0 10px #0f0; transform: scale(1.2); }
        .page { display: none; padding: 20px; padding-bottom: 80px; }
        .page.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* TABLERO */
        .gauge-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 20px; }
        .gauge { width: 130px; height: 130px; border: 3px solid #0f0; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #000; box-shadow: 0 0 15px #0f0 inset; }
        .gauge h1 { margin: 0; font-size: 35px; }
        canvas { width: 100%; height: 120px; background: #111; border: 1px solid #333; margin-top: 20px; }

        /* PANTALLA DE RESULTADOS DTC (LO NUEVO) */
        #dtcResult { 
            background: #111; border: 2px solid #f00; padding: 20px; margin-top: 20px; display: none; border-radius: 10px; 
            box-shadow: 0 0 20px #f00; 
        }
        .code-display { font-size: 40px; color: #ff0; font-weight: bold; margin: 10px 0; display: block; }
        
        .btn-dtc-action { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-google { background: #4285F4; color: #fff; }
        .btn-erase { background: #f00; color: #fff; }
        .btn-back { background: #0f0; color: #000; }

        .btn-action { background: #0f0; color: #000; padding: 15px 30px; border: none; font-weight: bold; border-radius: 50px; font-size: 18px; margin-top: 20px; box-shadow: 0 0 20px #0f0; width: 80%; cursor: pointer; }
        .btn-dtc-main { background: #f00; color: #fff; display: none; margin: 10px auto; box-shadow: 0 0 20px #f00; }

        /* OTROS */
        .search-bar { width: 90%; padding: 12px; background: #111; border: 1px solid #0f0; color: #fff; border-radius: 5px; font-size: 16px; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; text-align: left; margin-top: 5px; }
        th { background: #0f0; color: #000; padding: 8px; font-weight: bold; }
        td { border-bottom: 1px solid #333; padding: 10px 5px; }
        .money { color: #ff0; text-align: right; font-weight: bold; }
        .diag-card { border: 1px solid #333; background: #111; margin-bottom: 10px; padding: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; }
        .btn-view { background: #0f0; color: #000; border: none; padding: 5px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .assistant-box { background: #111; border: 1px solid #0ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 0 10px #0ff3; }
        #imgModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; display: none; justify-content: center; align-items: center; flex-direction: column; }
        #imgModal img { max-width: 95%; max-height: 80%; border: 2px solid #0f0; }
        #closeModal { margin-top: 20px; padding: 10px 30px; background: #f00; color: #fff; border: none; font-size: 18px; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="lockScreen"><h1>üîí BLOQUEADO</h1><p>LICENCIA VENCIDA</p><a href="#" class="btn-whatsapp">üì≤ RENOVAR</a></div>

    <div id="legalModal"><div class="legal-box"><h2 style="color:#f00;">‚ö†Ô∏è AVISO</h2><p>1. Referencia t√©cnica.</p><p>2. No nos hacemos responsables.</p><button id="btnAccept" onclick="acceptLegal()">ACEPTAR</button></div></div>

    <div id="p-dash" class="page">
        <h2>üèéÔ∏è DASHBOARD</h2>
        <div id="status" style="font-size: 10px; color: #777;">Listo para conectar</div>
        
        <div class="gauge-container">
            <div class="gauge"><span>RPM</span><h1 id="rpmVal">0</h1></div>
            <div class="gauge"><span>KM/H</span><h1 id="speedVal">0</h1></div>
            <div class="gauge"><span>TEMP</span><h1 id="tempVal">--</h1><span style="font-size:10px">¬∞C</span></div>
        </div>
        
        <canvas id="rpmChart"></canvas>
        
        <button id="btnConnect" class="btn-action">üîå CONECTAR</button>
        <button id="btnDTC" class="btn-action btn-dtc-main">üíÄ LEER C√ìDIGOS</button>
        
        <div id="dtcResult">
            <h3 style="color:#fff; margin:0;">RESULTADO DEL ESC√ÅNER:</h3>
            <span id="codeDisplay" class="code-display">...</span>
            <p id="codeDesc" style="font-size:12px; color:#aaa;">Esperando datos...</p>
            
            <button onclick="buscarEnGoogle()" class="btn-dtc-action btn-google">üîç ¬øQU√â SIGNIFICA?</button>
            <button onclick="borrarFallas()" class="btn-dtc-action btn-erase">üßπ BORRAR C√ìDIGOS (RESET)</button>
            <button onclick="volverARelojes()" class="btn-dtc-action btn-back">üèéÔ∏è VOLVER A RELOJES</button>
        </div>
    </div>

    <div id="p-inv" class="page">
        <h2>üì¶ INVENTARIO (+30%)</h2>
        <input type="text" id="searchInv" class="search-bar" placeholder="üîç Buscar...">
        <table><thead><tr><th width="15%">CANT</th><th>DESCRIPCI√ìN</th><th>PRECIO</th></tr></thead><tbody id="invBody"></tbody></table>
    </div>

    <div id="p-diag" class="page">
        <h2>üìÇ DIAGRAMAS</h2>
        <div class="assistant-box">
            <h3 style="margin-top:0; color:#0ff;">üïµÔ∏è‚Äç‚ôÇÔ∏è ASISTENTE</h3>
            <input type="text" id="autoInput" placeholder="Ej: Jetta A4 2002" style="width:90%; padding:10px; margin-bottom:10px;">
            <div style="display:flex; gap:10px;"><button onclick="buscarManual()" style="flex:1; padding:10px; background:#ff0;">üìÑ PDF</button><button onclick="buscarPinout()" style="flex:1; padding:10px; background:#0ff;">üîå PINOUT</button></div>
        </div>
        <h3 style="border-top:1px solid #333; padding-top:10px;">üíæ GUARDADOS:</h3>
        <input type="text" id="searchDiag" class="search-bar" placeholder="üîç Buscar..."><div id="diagList"></div>
    </div>

    <div id="imgModal"><img id="modalImg" src=""><button id="closeModal" onclick="closeImg()">CERRAR ‚ùå</button></div>

    <nav>
        <button onclick="nav('p-dash')" id="nav-dash">üèéÔ∏è</button>
        <button onclick="nav('p-inv')" id="nav-inv">üì¶</button>
        <button onclick="nav('p-diag')" id="nav-diag">üìÇ</button>
    </nav>

    <script>
        // CONFIGURACI√ìN
        const fechaVencimiento = new Date(2026, 2, 1);
        if (new Date() > fechaVencimiento) { document.getElementById('lockScreen').style.display = 'flex'; document.body.style.overflow = 'hidden'; }
        
        // LEGAL
        if (!localStorage.getItem('legalAccepted')) document.getElementById('legalModal').style.display = 'flex';
        else { document.getElementById('legalModal').style.display = 'none'; document.getElementById('p-dash').classList.add('active'); document.getElementById('nav-dash').classList.add('active'); }
        function acceptLegal() { localStorage.setItem('legalAccepted', 'true'); document.getElementById('legalModal').style.display = 'none'; document.getElementById('p-dash').classList.add('active'); document.getElementById('nav-dash').classList.add('active'); }

        // UTILS
        function nav(p) { document.querySelectorAll('.page').forEach(x => x.classList.remove('active')); document.querySelectorAll('nav button').forEach(x => x.classList.remove('active')); document.getElementById(p).classList.add('active'); if(p==='p-dash') document.getElementById('nav-dash').classList.add('active'); if(p==='p-inv') document.getElementById('nav-inv').classList.add('active'); if(p==='p-diag') document.getElementById('nav-diag').classList.add('active'); }
        function buscarManual() { let c = document.getElementById('autoInput').value; if(c) window.open('https://www.google.com/search?q=filetype:pdf+diagrama+electrico+taller+' + c, '_blank'); }
        function buscarPinout() { let c = document.getElementById('autoInput').value; if(c) window.open('https://www.google.com/search?tbm=isch&q=pinout+ecu+computadora+arnes+' + c, '_blank'); }

        // DIAGRAMAS & INVENTARIO
        const dbDiag = [{ nombre: "PINOUT CHEVY C2", archivo: "IMG_20260207_010441.jpg" }, { nombre: "ALTERNADOR NISSAN", archivo: "IMG_20260207_010417.jpg" }];
        const diagList = document.getElementById('diagList');
        document.getElementById('searchDiag').addEventListener('keyup', (e) => { diagList.innerHTML = ""; let t = e.target.value.toUpperCase(); dbDiag.forEach(d => { if(d.nombre.includes(t)) diagList.innerHTML += `<div class="diag-card"><div style="text-align:left;font-weight:bold;color:#fff;">${d.nombre}</div><button class="btn-view" onclick="document.getElementById('modalImg').src='${d.archivo}';document.getElementById('imgModal').style.display='flex'">VER üëÅÔ∏è</button></div>`; }); });
        document.getElementById('searchDiag').dispatchEvent(new Event('keyup'));
        function closeImg() { document.getElementById('imgModal').style.display = "none"; }

        const inv = [{c:"PC105309", d:"PORTA CARBON MARCHA GM AVEO", cost:75, q:2}, {c:"PC36441", d:"PORTA CARBON PLATINA/CHEVY", cost:69, q:3}];
        const invBody = document.getElementById('invBody');
        document.getElementById('searchInv').addEventListener('keyup', (e) => { invBody.innerHTML = ""; let t = e.target.value.toUpperCase(); inv.forEach(i => { if(i.d.includes(t)) { let v = (i.cost * 1.30).toFixed(0); invBody.innerHTML += `<tr><td style="font-weight:bold;color:#fff">${i.q}</td><td style="color:#ddd">${i.d}</td><td class="money">$${v}</td></tr>`; }}); });
        document.getElementById('searchInv').dispatchEvent(new Event('keyup'));

        // --- BLUETOOTH & L√ìGICA OBDII ---
        const UUIDS = ['000018f0-0000-1000-8000-00805f9b34fb', '0000fff0-0000-1000-8000-00805f9b34fb'];
        let service, writeChar, notifyChar, loop;
        let isReadingDTC = false;
        let ultimoCodigo = "";
        
        const ctx = document.getElementById('rpmChart').getContext('2d'); let chartData = new Array(50).fill(0);
        
        document.getElementById('btnConnect').addEventListener('click', async () => { try { document.getElementById('status').innerText="Buscando..."; const d = await navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices: UUIDS }); const s = await d.gatt.connect(); for (let u of UUIDS) { try { service = await s.getPrimaryService(u); break; } catch(e){} } const c = await service.getCharacteristics(); for (let x of c) { if (x.properties.write) writeChar = x; if (x.properties.notify) notifyChar = x; } await notifyChar.startNotifications(); notifyChar.addEventListener('characteristicvaluechanged', handleData); document.getElementById('status').innerText="‚úÖ CONECTADO"; document.getElementById('btnConnect').style.display='none'; document.getElementById('btnDTC').style.display='block'; await send("AT Z"); await wait(300); await send("AT SP0"); startLoop(); } catch(e){alert(e);} });

        async function send(c) { if(writeChar) await writeChar.writeValue(new TextEncoder().encode(c + '\r')); }
        function wait(ms) { return new Promise(r => setTimeout(r, ms)); }
        function startLoop() { let step = 0; loop = setInterval(() => { if(!isReadingDTC) { if(step===0) send("010C"); if(step===1) send("010D"); step=(step+1)%2; } }, 200); }

        // BOT√ìN LEER C√ìDIGOS
        document.getElementById('btnDTC').addEventListener('click', async () => {
             if(isReadingDTC) return;
             isReadingDTC = true;
             clearInterval(loop); // Parar relojes
             
             document.getElementById('dtcResult').style.display = 'block';
             document.getElementById('codeDisplay').innerText = "ESPERANDO...";
             document.getElementById('codeDesc').innerText = "Frenando comunicaci√≥n...";
             
             await wait(3000); // 3 seg enfriamiento
             document.getElementById('codeDesc').innerText = "Escaneando...";
             await send("03"); // Pedir fallas
        });

        // BOT√ìN BORRAR FALLAS
        async function borrarFallas() {
            if(confirm("¬øSeguro que quieres borrar los c√≥digos y apagar el Check Engine?")) {
                document.getElementById('codeDesc').innerText = "Borrando memoria...";
                await send("04"); // Comando Reset
                await wait(2000);
                alert("‚úÖ MEMORIA BORRADA. El Check Engine debe apagarse.");
                volverARelojes();
            }
        }

        // BOT√ìN GOOGLE
        function buscarEnGoogle() {
            if(ultimoCodigo && ultimoCodigo !== "...") window.open('https://www.google.com/search?q=codigo+falla+obd2+' + ultimoCodigo, '_blank');
            else alert("Primero lee los c√≥digos, carnal.");
        }

        // BOT√ìN VOLVER
        function volverARelojes() {
            document.getElementById('dtcResult').style.display = 'none';
            isReadingDTC = false;
            startLoop(); // Reiniciar RPM
        }

        function handleData(ev) { 
            let d = new TextDecoder().decode(ev.target.value).replace(/\s/g,'').trim(); 
            
            // Si estamos leyendo fallas
            if (isReadingDTC) {
                if(d.startsWith("43")) {
                    let raw = d.substring(2);
                    if(raw.includes("NO") || raw === "00") {
                        document.getElementById('codeDisplay').innerText = "SIN C√ìDIGOS";
                        document.getElementById('codeDisplay').style.color = "#0f0";
                        document.getElementById('codeDesc').innerText = "Sistema limpio.";
                    } else {
                        // Intentar formatear P0xxx (Ej: 0360 -> P0360)
                        let parsed = "P" + raw.substring(0, 4); 
                        ultimoCodigo = parsed;
                        document.getElementById('codeDisplay').innerText = parsed;
                        document.getElementById('codeDisplay').style.color = "#ff0";
                        document.getElementById('codeDesc').innerText = "Falla detectada. Busca en Google.";
                    }
                }
                return;
            }

            // Datos en vivo (RPM/Vel)
            if(d.includes("410C")) { let v=parseInt(d.split("410C")[1].substr(0,4),16)/4; document.getElementById('rpmVal').innerText=Math.round(v); updateChart(v); } 
            if(d.includes("410D")) document.getElementById('speedVal').innerText=parseInt(d.split("410D")[1].substr(0,2),16);
        }

        function updateChart(v) { chartData.push(v); chartData.shift(); ctx.clearRect(0,0,300,120); ctx.beginPath(); ctx.strokeStyle='#0f0'; chartData.forEach((val,i) => { let y=120-(val/6000)*120; i==0?ctx.moveTo(i*6,y):ctx.lineTo(i*6,y); }); ctx.stroke(); }
    </script>
</body>
</html>
