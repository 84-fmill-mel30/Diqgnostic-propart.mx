<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROPART MASTER HUB V9 | MASTER DEPLOYMENT</title>
    <!-- Arsenal Tecnológico Master -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root { --neon: #22d3ee; --bg: #020617; --amber: #fbbf24; --emerald: #10b981; --rose: #f43f5e; }
        body { 
            background-color: var(--bg); 
            color: #f8fafc; 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            overflow: hidden; 
            height: 100vh;
            margin: 0;
        }
        
        /* Efecto Cristal de Nivel Premium */
        .glass { 
            background: rgba(15, 23, 42, 0.98); 
            backdrop-filter: blur(30px); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 1.5rem; 
        }
        
        .active-tab { 
            background: rgba(34, 211, 238, 0.1); 
            border-bottom: 3px solid var(--neon); 
            color: var(--neon); 
        }
        
        /* Contenedor del Holograma */
        #main-viewport { 
            width: 100%; 
            height: 320px; 
            cursor: grab; 
            background: radial-gradient(circle at center, rgba(34, 211, 238, 0.15) 0%, transparent 85%); 
            border-radius: 1.5rem; 
        }

        .terminal-box { 
            background: rgba(0,0,0,0.95); 
            border: 1px solid rgba(34, 211, 238, 0.3); 
            border-radius: 1.2rem; 
            font-family: 'Consolas', 'Courier New', monospace; 
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        @keyframes pulse-sync { 0%, 100% { opacity: 1; filter: drop-shadow(0 0 12px var(--neon)); } 50% { opacity: 0.4; } }
        .mode-ready { animation: pulse-sync 2s infinite; color: var(--emerald); font-weight: 900; font-size: 10px; letter-spacing: 2px; }

        .btn-master { 
            background: #1e293b; 
            border: 1px solid #334155; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .btn-master:active { transform: scale(0.95); background: #334155; }
        
        .fault-card { 
            background: rgba(244, 63, 94, 0.1); 
            border-left: 4px solid var(--rose); 
            animation: slideIn 0.3s ease-out; 
        }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="flex flex-col select-none">

    <!-- Header Master Propart Diagnostic -->
    <header class="glass mx-3 mt-3 p-4 flex flex-col items-center border-b border-white/5 sticky top-0 z-50">
        <div class="flex items-center gap-4 w-full justify-between">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-blue-600 rounded-lg shadow-lg font-black text-white text-[10px] uppercase tracking-tighter italic">V9 DEPLOY</div>
                <h1 class="text-xl font-black tracking-tighter uppercase italic leading-none">Propart <span class="text-cyan-400">Master</span></h1>
            </div>
            <div id="conn-pill" class="flex items-center gap-2 bg-slate-900 px-3 py-1 rounded-full border border-white/10">
                <div id="bt-led" class="w-2.5 h-2.5 rounded-full bg-slate-700 transition-all duration-500"></div>
                <span id="bt-status" class="text-[9px] font-bold text-slate-500 uppercase tracking-widest italic">Offline</span>
            </div>
        </div>
        
        <!-- Navegación de Pestañas Master -->
        <nav class="flex mt-4 bg-slate-900/80 p-1 rounded-2xl border border-white/5 w-full max-w-md gap-1">
            <button onclick="switchTab('diag')" id="tab-diag-btn" class="tab-btn py-2 text-[10px] font-black uppercase rounded-xl flex-1 active-tab italic">Escanear</button>
            <button onclick="switchTab('bench')" id="tab-bench-btn" class="tab-btn py-2 text-[10px] font-black uppercase rounded-xl flex-1 text-slate-500 italic">Test Banco</button>
            <button onclick="switchTab('3d')" id="tab-3d-btn" class="tab-btn py-2 text-[10px] font-black uppercase rounded-xl flex-1 text-slate-500 italic">3D Lab</button>
        </nav>
    </header>

    <main class="flex-grow overflow-y-auto custom-scroll p-4 space-y-6">

        <!-- MODO ESCANEO (Optimizado para el Vehículo) -->
        <section id="content-diag" class="tab-content block space-y-4">
            <div class="flex justify-between items-center px-2">
                <h2 class="text-xs font-black uppercase tracking-widest text-slate-400 italic">Diagnóstico en Vehículo</h2>
                <span id="car-status" class="text-[9px] text-slate-500 font-bold uppercase italic tracking-tighter">Esperando Handshake...</span>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="fullSync()" id="mainConnectBtn" class="btn-master p-6 rounded-3xl flex flex-col items-center gap-3 border border-cyan-500/40 shadow-xl shadow-cyan-950/20">
                    <i class="fas fa-satellite-dish text-cyan-400 text-2xl animate-pulse"></i>
                    <span class="text-[9px] font-black uppercase tracking-widest text-cyan-400">Enlazar vLink</span>
                </button>
                <button onclick="readDTC()" class="btn-master p-6 rounded-3xl flex flex-col items-center gap-3 shadow-xl">
                    <i class="fas fa-microscope text-amber-500 text-2xl"></i>
                    <span class="text-[9px] font-black uppercase tracking-widest text-amber-500">Leer DTCs</span>
                </button>
            </div>

            <div id="results-log" class="space-y-3">
                <h3 class="text-[10px] font-black text-slate-500 uppercase px-2 tracking-widest italic">Códigos en Memoria</h3>
                <div id="placeholder-msg" class="text-center py-8 border-2 border-dashed border-slate-800 rounded-3xl">
                    <i class="fas fa-car-crash text-slate-800 text-3xl mb-2"></i>
                    <p class="text-[10px] text-slate-600 font-bold uppercase tracking-tighter italic">Listo para el campo, socio Millán.</p>
                </div>
            </div>
        </section>

        <!-- MODO BANCO (Pruebas de Hardware en casa) -->
        <section id="content-bench" class="tab-content hidden space-y-4">
            <div class="flex justify-between items-center px-2">
                <h2 class="text-xs font-black uppercase tracking-widest text-slate-400 italic">Módulo de Ingeniería</h2>
                <span class="mode-ready uppercase italic tracking-tighter">Bench Mode Active</span>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="sendAT('ATI')" class="btn-master p-6 rounded-3xl flex flex-col items-center gap-3 shadow-lg">
                    <i class="fas fa-id-card text-emerald-400 text-xl"></i>
                    <span class="text-[9px] font-black uppercase tracking-widest text-emerald-400">ID del Chip</span>
                </button>
                <button onclick="sendAT('ATRV')" class="btn-master p-6 rounded-3xl flex flex-col items-center gap-3 shadow-lg">
                    <i class="fas fa-bolt text-amber-400 text-xl"></i>
                    <span class="text-[9px] font-black uppercase tracking-widest text-amber-400">Leer Voltaje</span>
                </button>
                <button onclick="sendAT('ATZ')" class="btn-master p-6 rounded-3xl flex flex-col items-center gap-3 col-span-2 border border-rose-500/20">
                    <i class="fas fa-power-off text-rose-500 text-xl"></i>
                    <span class="text-[9px] font-black uppercase tracking-widest text-rose-500">Resetear vLink</span>
                </button>
            </div>

            <!-- Terminal Master (Log de Datos HEX) -->
            <div class="terminal-box p-5 flex flex-col h-72 shadow-2xl border border-white/5">
                <div class="flex justify-between items-center mb-3 border-b border-white/10 pb-2">
                    <span class="text-[10px] font-black text-cyan-400 uppercase italic tracking-tighter">Engineering Terminal Log</span>
                    <button onclick="document.getElementById('console').innerHTML = ''" class="text-[9px] text-slate-500 font-bold uppercase hover:text-white transition-colors">Limpiar</button>
                </div>
                <div id="console" class="flex-grow font-mono text-[11px] text-cyan-300 overflow-y-auto custom-scroll space-y-1">
                    <div class="text-slate-600 italic font-bold uppercase">> Sistema V9 Listo. Socio Millán al mando.</div>
                </div>
            </div>
        </section>

        <!-- LABORATORIO 3D (Inspección Técnica) -->
        <section id="content-3d" class="tab-content hidden space-y-4">
            <div class="glass overflow-hidden relative border border-cyan-500/20 shadow-2xl">
                <div id="main-viewport"></div>
                <div class="absolute bottom-6 left-0 right-0 text-center pointer-events-none">
                    <p id="proj-name" class="text-sm font-black text-white uppercase tracking-[0.4em] drop-shadow-lg italic">Modelo de Ingeniería</p>
                </div>
            </div>
            <button onclick="update3D('engine')" class="glass p-5 w-full flex justify-between items-center border-l-4 border-cyan-500 uppercase font-black text-xs active:scale-95 transition-all">
                Bloque Motor VAG 2005
                <i class="fas fa-cube text-cyan-400 text-xl"></i>
            </button>
        </section>

    </main>

    <!-- Barra de Comandos Millán (Línea Directa de Ingeniería) -->
    <footer class="p-4 glass border-t border-white/5 sticky bottom-0 mx-3 mb-3">
        <div class="flex flex-col gap-2">
            <div class="flex gap-2">
                <input type="text" id="cmdInput" placeholder="Enviar AT o HEX Manual (Ej: 03)..." class="flex-grow bg-slate-950 border border-slate-700 rounded-2xl px-5 py-3.5 text-white text-xs outline-none focus:ring-1 focus:ring-blue-500 font-bold uppercase tracking-wider italic placeholder:text-slate-800">
                <button onclick="sendManual()" class="bg-blue-600 px-7 rounded-2xl flex items-center justify-center active:scale-90 transition-transform shadow-lg shadow-blue-900/20">
                    <i class="fas fa-paper-plane text-white text-sm"></i>
                </button>
            </div>
            <p class="text-center text-[7px] font-bold text-slate-800 uppercase tracking-[0.5em] mt-3 italic">
                JULS AI SPECIALIST | PROPART DIAGNOSTIC MASTER © 2026 | SOCIO MILLÁN
            </p>
        </div>
    </footer>

    <script>
        // --- MOTOR MASTER V9 (QUANTUM DISCOVERY) ---
        let obdChar = null;
        let bleDevice = null;

        // Lista Maestra de UUIDs para barrer el vLink (Fix "No Services")
        const MASTER_UUIDS = [
            '0000fff0-0000-1000-8000-00805f9b34fb', // Standard vLink
            '49535343-fe7d-4ae5-8fa9-9fafd205e455', // IOS-Vlink Protocol
            '0000ffe0-0000-1000-8000-00805f9b34fb', // BLE Serial Generic
            '000018f0-0000-1000-8000-00805f9b34fb', // OBDII Standard
            '00001101-0000-1000-8000-00805f9b34fb'  // Classic SPP
        ];

        function log(msg, type = 'sys') {
            const consoleEl = document.getElementById('console');
            const time = new Date().toLocaleTimeString([], { hour12: false });
            const prefix = type === 'tx' ? 'ENVIANDO > ' : type === 'rx' ? 'RECIBIDO < ' : 'SISTEMA | ';
            const color = type === 'tx' ? 'text-white font-bold' : type === 'rx' ? 'text-cyan-400 font-black' : 'text-slate-600';
            consoleEl.innerHTML += `<div><span class="text-slate-800 font-black">[${time}]</span> <span class="${color}">${prefix}${msg}</span></div>`;
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        async function fullSync() {
            const btn = document.getElementById('mainConnectBtn');
            try {
                log("Iniciando Escaneo Cuántico Discovery...");
                btn.innerHTML = '<i class="fas fa-atom fa-spin"></i><span class="ml-2 uppercase">Vinculando...</span>';
                
                // Bypass de filtros de servicio
                bleDevice = await navigator.bluetooth.requestDevice({ 
                    acceptAllDevices: true, 
                    optionalServices: MASTER_UUIDS 
                });
                
                log(`Socio Millán, enlazado con: ${bleDevice.name}`);
                const server = await bleDevice.gatt.connect();
                log("Servidor GATT activo. Analizando canales...");
                
                // Discovery Loop Inteligente
                const services = await server.getPrimaryServices();
                for (const s of services) {
                    const chars = await s.getCharacteristics();
                    for (const c of chars) { 
                        if (c.properties.write || c.properties.writeWithoutResponse) { 
                            obdChar = c; 
                            log(`Canal de datos hallado en Service: ${s.uuid.substring(0,8)}`);
                            break; 
                        } 
                    }
                    if (obdChar) break;
                }

                if (!obdChar) throw new Error("No se halló el canal de datos del vLink.");

                if (obdChar.properties.notify) {
                    await obdChar.startNotifications();
                    obdChar.addEventListener('characteristicvaluechanged', (e) => { 
                        const val = new TextDecoder().decode(e.target.value).trim();
                        if(val) handleResponse(val);
                    });
                }

                document.getElementById('bt-led').className = "w-2.5 h-2.5 rounded-full bg-cyan-400 shadow-[0_0_12px_#22d3ee]";
                document.getElementById('bt-status').innerText = "Vlink Online";
                document.getElementById('car-status').innerText = "Enlace listo para el diagnóstico";
                document.getElementById('car-status').className = "text-[9px] text-emerald-400 font-bold uppercase italic";
                btn.innerHTML = '<i class="fas fa-check-double text-emerald-500"></i><span class="ml-2 text-emerald-500 uppercase font-black">VINCULADO</span>';
                
                log("Sincronización Total. Mandando ATZ.");
                await sendAT("ATZ");
            } catch (err) { 
                log(`FALLO: ${err.message}`, 'sys'); 
                btn.innerHTML = 'REINTENTAR';
                alert("Socio, hubo un error. Revisa que el vLink esté alimentado.");
            }
        }

        async function sendAT(cmd) {
            if (!obdChar) return;
            try {
                // El chip requiere retorno de carro \r
                await obdChar.writeValue(new TextEncoder().encode(cmd + "\r"));
                log(cmd, 'tx');
            } catch (e) { log("Fallo en el canal de datos.", "sys"); }
        }

        function handleResponse(data) {
            log(data, 'rx');
            // Decodificador para modo 03 (Códigos de Falla)
            if (data.includes("43")) { 
                const container = document.getElementById('results-log');
                const placeholder = document.getElementById('placeholder-msg');
                if(placeholder) placeholder.remove();
                
                const raw = data.replace(/43/g, "").trim().split(" ");
                if(raw[0] === "00") {
                    container.innerHTML += '<div class="text-center py-4 text-emerald-400 font-bold text-[10px] uppercase italic">✓ Sin fallas activas</div>';
                } else {
                    const code = "P" + raw[0] + (raw[1] || "00");
                    const div = document.createElement('div');
                    div.className = "glass p-4 fault-card flex justify-between items-center";
                    div.innerHTML = `<div><span class="text-sm font-black text-rose-500">${code}</span><p class="text-[9px] text-slate-400 font-bold mt-1 uppercase italic">Falla Detectada</p></div><button onclick="switchTab('3d')" class="text-[8px] bg-rose-500/20 text-rose-500 px-3 py-1 rounded-full font-black uppercase">Inspección 3D</button>`;
                    container.appendChild(div);
                }
            }
        }

        function readDTC() {
            if(!obdChar) { alert("¡Socio! Primero enlaza el vLink."); return; }
            log("Rastreando memoria de ECU (Modo 03)...");
            sendAT("03");
        }

        function sendManual() {
            const input = document.getElementById('cmdInput');
            if (input.value) { sendAT(input.value.toUpperCase()); input.value = ""; }
        }

        // --- LÓGICA DE SPA ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active-tab'); b.classList.add('text-slate-500'); });
            document.getElementById(`content-${id}`).classList.remove('hidden');
            document.getElementById(`tab-${id}-btn`).classList.add('active-tab');
            document.getElementById(`tab-${id}-btn`).classList.remove('text-slate-500');
        }

        // --- MOTOR 3D Master ---
        let scene, camera, renderer, object;
        function init3D() {
            const v = document.getElementById('main-viewport');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, v.clientWidth / v.clientHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(v.clientWidth, v.clientHeight);
            v.appendChild(renderer.domElement);

            const light = new THREE.PointLight(0xffffff, 2, 100); light.position.set(10, 10, 10);
            scene.add(light); scene.add(new THREE.AmbientLight(0x404040, 2));
            camera.position.z = 5;

            // Icosaedro como placeholder de bloque motor
            object = new THREE.Mesh(new THREE.IcosahedronGeometry(2, 1), new THREE.MeshPhongMaterial({ color: 0x22d3ee, wireframe: true }));
            scene.add(object);

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            if (object) object.rotation.y += 0.005;
            renderer.render(scene, camera);
        }

        window.onload = init3D;
        window.onresize = () => {
            const v = document.getElementById('main-viewport');
            camera.aspect = v.clientWidth / v.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(v.clientWidth, v.clientHeight);
        };
    </script>
</body>
</html>
