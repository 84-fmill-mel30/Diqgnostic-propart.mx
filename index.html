<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>PROPART ULTIMATE V99</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { background: #000; color: #0f0; font-family: 'Courier New', monospace; text-align: center; margin: 0; overflow-x: hidden; touch-action: manipulation; }
        
        /* PANELES */
        .panel { border: 1px solid #333; margin: 10px; padding: 10px; border-radius: 10px; background: #0a0a0a; box-shadow: 0 0 10px #0f02; }
        
        /* RELOJES */
        #gauges { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .gauge { 
            width: 45%; max-width: 150px; height: 100px; 
            border: 2px solid #0f0; border-radius: 10px;
            display: flex; flex-direction: column; justify-content: center;
            background: #000;
        }
        .big-gauge { width: 90%; height: 120px; border-color: #ff0; color: #ff0; }
        
        h1 { margin: 0; font-size: 40px; }
        .big-gauge h1 { font-size: 60px; }
        span { font-size: 12px; opacity: 0.7; }

        /* GR√ÅFICA EN VIVO */
        canvas { width: 100%; height: 150px; background: #111; border-top: 1px solid #0f0; border-bottom: 1px solid #0f0; margin-top: 10px; }

        /* BOTONES */
        .btn-group { display: flex; gap: 10px; padding: 10px; justify-content: center; }
        button { 
            padding: 15px; font-size: 16px; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; flex: 1;
        }
        #btnConnect { background: #0f0; color: #000; box-shadow: 0 0 15px #0f0; }
        #btnDTC { background: #f00; color: #fff; display: none; } /* Oculto hasta conectar */

        /* ERRORES DTC */
        #dtcArea { text-align: left; padding: 10px; color: #ff5555; display: none; min-height: 100px; }
        
        #status { font-size: 10px; color: #666; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="status">SISTEMA MULTIMARCA LISTO</div>

    <div id="gauges">
        <div class="gauge big-gauge">
            <span>RPM MOTOR</span>
            <h1 id="rpmVal">0</h1>
        </div>
        <div class="gauge">
            <span>VELOCIDAD</span>
            <h1 id="speedVal">0</h1>
            <span>KM/H</span>
        </div>
        <div class="gauge">
            <span>TEMP AGUA</span>
            <h1 id="tempVal">--</h1>
            <span>¬∞C</span>
        </div>
    </div>

    <div class="panel">
        <span>HISTORIAL RPM (EN VIVO)</span>
        <canvas id="rpmChart"></canvas>
    </div>

    <div id="dtcArea" class="panel">
        <h3>üîç DIAGN√ìSTICO:</h3>
        <p id="dtcList">Sin escanear...</p>
    </div>

    <div class="btn-group">
        <button id="btnConnect">‚ö° CONECTAR AL AUTO</button>
        <button id="btnDTC">üíÄ LEER C√ìDIGOS (DTC)</button>
    </div>

    <script>
        // --- LISTA DE LLAVES PARA TODOS LOS ESC√ÅNERES (MULTIMARCA) ---
        const POSIBLES_UUIDS = [
            '000018f0-0000-1000-8000-00805f9b34fb', // TU ESC√ÅNER (V-Link)
            '0000fff0-0000-1000-8000-00805f9b34fb', // GEN√âRICOS (ELM327)
            '0000ffe0-0000-1000-8000-00805f9b34fb'  // CHINOS (HM-10)
        ];

        let device, server, service, writeChar, notifyChar;
        let isConnected = false;
        
        // Elementos
        const rpmVal = document.getElementById('rpmVal');
        const speedVal = document.getElementById('speedVal');
        const tempVal = document.getElementById('tempVal');
        const status = document.getElementById('status');
        const dtcList = document.getElementById('dtcList');
        const dtcArea = document.getElementById('dtcArea');

        // GR√ÅFICA (CANVAS)
        const canvas = document.getElementById('rpmChart');
        const ctx = canvas.getContext('2d');
        let rpmHistory = new Array(100).fill(0); // Guardamos 100 datos
        
        // Ajustar tama√±o canvas
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        // --- CONEXI√ìN ---
        document.getElementById('btnConnect').addEventListener('click', async () => {
            try {
                status.innerText = "üîç Buscando cualquier esc√°ner...";
                
                // Pedimos permiso para TODAS las llaves posibles
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: POSIBLES_UUIDS
                });

                status.innerText = "Conectando...";
                server = await device.gatt.connect();
                
                // BUSCAR CU√ÅL LLAVE SIRVE (MULTIMARCA)
                status.innerText = "Probando protocolos...";
                service = null;
                
                for (let uuid of POSIBLES_UUIDS) {
                    try {
                        service = await server.getPrimaryService(uuid);
                        status.innerText = "‚úÖ Llave encontrada: " + uuid.substring(4,8);
                        console.log("Servicio activo: " + uuid);
                        break; // Si encontramos uno, nos salimos del bucle
                    } catch (e) { console.log("No es " + uuid); }
                }

                if (!service) throw "No se encontr√≥ servicio compatible (V-Link/ELM)";

                // Buscar caracter√≠sticas dentro del servicio
                const chars = await service.getCharacteristics();
                for (let c of chars) {
                    if (c.properties.write) writeChar = c;
                    if (c.properties.notify) notifyChar = c;
                }

                if (!writeChar || !notifyChar) throw "Faltan permisos de lectura/escritura";

                await notifyChar.startNotifications();
                notifyChar.addEventListener('characteristicvaluechanged', handleData);

                // INTERFAZ LISTA
                status.innerText = "üöÄ SISTEMA OPERATIVO";
                status.style.color = "#0f0";
                document.getElementById('btnConnect').style.display = 'none';
                document.getElementById('btnDTC').style.display = 'block';
                isConnected = true;

                // INICIAR SECUENCIA
                await sendCmd("AT Z");   // Reiniciar
                await delay(500);
                await sendCmd("AT SP0"); // Protocolo Autom√°tico (Multimarca)
                await delay(500);
                startLoop();             // Arrancar datos en vivo

            } catch (err) {
                status.innerText = "‚ùå ERROR: " + err;
                status.style.color = "red";
            }
        });

        // --- LECTURA DE C√ìDIGOS DE FALLA (DTC) ---
        document.getElementById('btnDTC').addEventListener('click', async () => {
            if (!isConnected) return;
            dtcArea.style.display = 'block';
            dtcList.innerText = "Escaneando computadora...";
            pausaLoop = true; // Pausar datos en vivo para leer errores
            await sendCmd("03"); // Comando para pedir c√≥digos
        });

        // --- ENV√çO Y RECEPCI√ìN ---
        async function sendCmd(cmd) {
            if (!writeChar) return;
            const encoder = new TextEncoder();
            await writeChar.writeValue(encoder.encode(cmd + '\r'));
        }

        let loopInterval;
        let step = 0;
        let pausaLoop = false;

        function startLoop() {
            loopInterval = setInterval(() => {
                if (pausaLoop) return; // Si estamos leyendo errores, no pedir RPM
                
                if (step === 0) sendCmd("010C"); // RPM
                if (step === 1) sendCmd("010D"); // Velocidad
                if (step === 2) sendCmd("0105"); // Temperatura
                
                step++;
                if (step > 2) step = 0;
            }, 150); // Velocidad turbo
        }

        function handleData(event) {
            const decoder = new TextDecoder();
            let raw = decoder.decode(event.target.value).replace(/\s+/g, '').trim(); // Limpiar

            // RESPUESTA DE DTC (C√ìDIGOS DE FALLA)
            if (raw.startsWith("43")) { 
                interpretDTC(raw);
                setTimeout(() => { pausaLoop = false; }, 3000); // Reanudar datos en 3 seg
                return;
            }

            // DATOS EN VIVO
            if (raw.includes("410C")) { // RPM
                let val = parseHex(raw, "410C") / 4;
                rpmVal.innerText = Math.round(val);
                updateChart(val); // Mover gr√°fica
            }
            else if (raw.includes("410D")) { // VELOCIDAD
                speedVal.innerText = parseHex(raw, "410D");
            }
            else if (raw.includes("4105")) { // TEMP
                let temp = parseHex(raw, "4105") - 40;
                tempVal.innerText = temp;
                tempVal.style.color = temp > 95 ? "red" : "#ff0";
            }
        }

        // INTERPRETAR ERRORES (P0300, etc)
        function interpretDTC(hexData) {
            // Ejemplo respuesta: 43 01 33 00 00 00...
            // Los c√≥digos vienen en pares de bytes.
            let codes = [];
            let data = hexData.substring(2); // Quitar el 43
            
            for (let i = 0; i < data.length; i += 4) {
                let codeHex = data.substring(i, i+4);
                if (codeHex === "0000") continue; // Vac√≠o
                if (codeHex.length < 4) continue;

                // Traducir primer letra (P, C, B, U)
                let firstChar = parseInt(codeHex[0], 16);
                let letter = "";
                let n1 = "";
                
                // L√≥gica est√°ndar OBD2 para decodificar
                if (firstChar >= 0 && firstChar <= 3) { letter = "P0"; n1 = firstChar; }
                else if (firstChar >= 4 && firstChar <= 7) { letter = "C0"; n1 = firstChar - 4; }
                else if (firstChar >= 8 && firstChar <= 11) { letter = "B0"; n1 = firstChar - 8; }
                else { letter = "U0"; n1 = firstChar - 12; }
                
                let cleanCode = letter + codeHex.substring(1);
                codes.push(cleanCode);
            }

            if (codes.length === 0) {
                dtcList.innerText = "‚úÖ SIN C√ìDIGOS DE FALLA";
                dtcList.style.color = "#0f0";
            } else {
                dtcList.innerText = "‚ö†Ô∏è FALLAS: " + codes.join(", ");
                dtcList.style.color = "red";
            }
        }

        // --- UTILIDADES ---
        function parseHex(str, header) {
            let parts = str.split(header);
            if (parts[1] && parts[1].length >= 2) {
                return parseInt(parts[1].substring(0, parts[1].length >= 4 ? 4 : 2), 16);
            }
            return 0;
        }

        function updateChart(newRpm) {
            rpmHistory.push(newRpm);
            rpmHistory.shift(); // Quitar el m√°s viejo
            
            // Dibujar
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.strokeStyle = '#0f0';
            ctx.lineWidth = 2;
            
            let w = canvas.width / rpmHistory.length;
            for (let i = 0; i < rpmHistory.length; i++) {
                let h = (rpmHistory[i] / 8000) * canvas.height; // Escala a 8000 rpm
                let y = canvas.height - h;
                if (i===0) ctx.moveTo(i*w, y);
                else ctx.lineTo(i*w, y);
            }
            ctx.stroke();
        }

        function delay(ms) { return new Promise(r => setTimeout(r, ms)); }
    </script>
</body>
</html>
